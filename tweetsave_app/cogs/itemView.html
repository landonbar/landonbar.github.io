
<blueprint>

    <data name="selected" prop="true"/>
    <sensor node="itemView" on="click" transform="toggleSelected" pipe="selected" />

    <sensor watch="item" change="true" run="markSaved" />

    <prop find="saves" />
    <prop find="saveHash" />

    <cog find="itemView" url="tweet.html" />


</blueprint>


<display>
    <div>
        <div  class="Grid-cell  tweetButton " id="button" style="max-width: 380px; flex-wrap: wrap;">
            <div id="itemView" class="Demo">
            </div>
        </div>
    </div>
</display>

<script>

    $.cog({

        init: function() {

        },

        toggleSelected: function(e) {

            if (e.target && e.target.localName && e.target.localName=='a') return this.selected.read() ;


            this.button.toggleClass('focusTweet');
            var newSaves = this.saves.read();
            var hash = this.saveHash.read();
            var selected =false;

            if (this.selected.read()) {
                selected=false;
                if(hash[this.item.id]!==undefined){
                    newSaves.saves.splice(hash[this.item.id],1)
                }
            }
            else {
                selected=true;
                newSaves.saves.push(this.item);
            }
            this.saves.write(newSaves);

            return selected;
        },

        markSaved: function (msg) {

            var hash = this.saveHash.read();
            if(hash[msg.id]) {
                this.selected.write(true);
                this.button.addClass('focusTweet');
            }
            else {
                this.button.removeClass('focusTweet');
            }
        }

//        ,render: function(msg){
//
//            this.item=msg;
//
//            var hash = this.saveHash.read();
//            if(hash[msg.id]) {
//                this.selected.write(true);
//                this.button.addClass('focusTweet');
//            }
//            else {
//                this.button.removeClass('focusTweet');
//            }
//
//
//            var bits = msg.text.split(' ');
//            for (var x=0; x<bits.length;x++){
//                if (bits[x].indexOf('@')===0) {
//                    bits[x] = '<a href="/index.html#/search/at/' + encodeURI(bits[x].substr(1)) + '">' + bits[x] + '</a>';
//                }
//                else if (bits[x].indexOf('#')===0) {
//                    bits[x] = '#<a href="/index.html#/search/hash/' + encodeURI(bits[x].substr(1)) + '">' + bits[x].substr(1) + '</a>';
//                }
//                else if (bits[x].indexOf('http')===0) {
//                    bits[x] = '<a target="_blank" href="' + bits[x] + '">' + bits[x].replace('https://','').replace('http://','') + '</a>';
//                }
//            }
//            var html = bits.join(' ');
//
//            this.tweetText.html(html);
//            this.user.text(msg.user_name);
//            this.handle.text(msg.user_screen_name);
//            this.profilePic.attr('src',msg.user_img_url);
//            if (msg.photo!='' ) {
//                this.photo.html('<img id="photo" class="" src="'+ msg.photo + '" />');
//            }
//            else {
//                this.photo.html('');
//            }
//
//        }

    });

</script>